name: TVBox Parses Evolution (Stable)

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Fetch upstream dianshi.json
        run: |
          curl -L -o upstream.json \
          https://raw.githubusercontent.com/qist/tvbox/master/dianshi.json

      - name: Init stats (safe)
        run: |
          [ -f parses_stats.json ] || echo '{}' > parses_stats.json

      - name: Normalize upstream → base.json
        run: |
          jq '
            .parses = (
              .parses
              | map(
                  if .name == "Json聚合" and .type == 3 and .url == "Demo" then
                    [
                      {"name":"解析聚合","type":3,"url":"Demo"},
                      {"name":"Json并发","type":2,"url":"Parallel"},
                      {"name":"Json轮询","type":2,"url":"Sequence"}
                    ]
                  else
                    .
                  end
                )
              | flatten
            )
            | .spider = "https://raw.githubusercontent.com/qist/tvbox/master/jar/fan.txt;md5;3962e9dbce2c7b61a53b1b796f098d47"
          ' upstream.json > base.json

      - name: Auto group + learning
        run: |
          MAX_PARALLEL=6
          FAST=()
          SLOW=()

          jq -c '.parses[]' base.json | while read -r item; do
            url=$(echo "$item" | jq -r '.url')

            if [[ "$url" == "Demo" || "$url" == "Parallel" || "$url" == "Sequence" ]]; then
              continue
            fi

            key=$(echo -n "$url" | md5sum | cut -d' ' -f1)
            ok=$(jq -r ".\"$key\".ok // 0" parses_stats.json)
            total=$(jq -r ".\"$key\".total // 0" parses_stats.json)

            start=$(date +%s%3N)
            if curl -k -L -A "Mozilla/5.0" \
                --range 0-0 \
                --connect-timeout 4 \
                --max-time 6 \
                -s "$url" >/dev/null; then
              hit=1
            else
              hit=0
            fi
            end=$(date +%s%3N)
            cost=$((end - start))

            jq ".\"$key\" = {ok: ($ok + $hit), total: ($total + 1)}" \
              parses_stats.json > tmp && mv tmp parses_stats.json

            score=$(( (ok * 100 / (total + 1)) - cost ))

            if [[ $hit -eq 1 && $cost -le 3000 ]]; then
              FAST+=("$item")
            else
              SLOW+=("$item")
            fi
          done

          printf '%s\n' "${FAST[@]}" | head -n $MAX_PARALLEL > fast.txt
          printf '%s\n' "${FAST[@]:$MAX_PARALLEL}" "${SLOW[@]}" > slow.txt

          jq -s '.' fast.txt > parallel.json
          jq -s '.' slow.txt > sequence.json

      - name: Build final aiyouteng.json
        run: |
          jq --slurpfile p parallel.json --slurpfile s sequence.json '
            .parses = (
              [
                {"name":"并发·主力","type":2,"url":"Parallel"},
                {"name":"轮询·兜底","type":2,"url":"Sequence"},
                {"name":"聚合·保底","type":3,"url":"Demo"}
              ]
              + $p[0] + $s[0]
            )
          ' base.json > aiyouteng.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add aiyouteng.json parses_stats.json
          git diff --cached --quiet || git commit -m "evolve parses with learning"
          git push
